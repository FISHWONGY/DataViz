```{r}
library(readr)
library(ggplot2)
library(delabj)
library(ggtext)
library(paletteer)
library(evoPalette)
library(ghibli)
library(patchwork)
library(tidyverse)
library(ggrepel)
```


```{r}
anime <- read_csv(file="https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-04-23/tidy_anime.csv")
```

```{r}
anime$year <- as.numeric(substr(anime$start_date, 1,4))
anime <- anime %>% 
            select(1:4, 6:10, 14, 18,20,21, 29)  %>%
            #mutate(year = as.numeric(year)) %>%
            mutate(decade = year - year %% 10)
```

```{r}
producer <- anime %>%
  group_by(producers) %>% 
               count(producers) %>%
               ungroup() %>%
 # mutate_at(c("producers"), as.factor) %>%
  drop_na(producers)%>%
  arrange(-n) 
```

```{r}
pro_yr <- anime %>%
  group_by(producers, decade) %>% 
  count(producers, decade) %>%
  ungroup() %>%
  #mutate_at(c("producers"), as.factor) %>%
  drop_na(producers, decade)%>%
  arrange(decade) %>%
  filter(producers %in% c("TV Tokyo", "Aniplex", "Bandai Visual", "NHK", "Fuji TV", "Sotsu", "Dentsu", "Square Enix",
                          "AT-X","Kadokawa Shoten", "TBS"))
```

#Plot for producer
```{r}
p1 <-
producer %>%
  top_n(10) %>%
  
ggplot(aes(x = reorder(producers, n), y = n)) + 
  geom_col(fill = "#729ec4") + #position = "dodge", #83B692
  theme_delabj_dark() + 
  scale_y_continuous(position = "right") +
  geom_text(aes(y = n, label = n), size = 12, nudge_y = -100, color = "white", family="ITC Officina Sans LT Book") +
  theme(text = element_text( family="ITC Officina Sans LT Book", size = 13),
        panel.grid.major = element_line(color = "white", size = 0.3), 
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.background = element_blank(),
        axis.line.x.top = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(family = "ITC Officina Sans LT Bold", size = 25),
        axis.text.y = element_text(size = 25),
        #axis.text.y = element_text(size = 10, family = "ITC Officina Sans LT Bold"),
        plot.title = element_markdown(hjust = 0, vjust=-0.12, size = 36, 
                                  family="ITC Officina Sans LT Bold"),
        plot.subtitle = element_markdown(hjust = 0, vjust=-1.5, size = 25),
       plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0, vjust = -2.5, size = 15)) +
  labs(x = "", y = "", 
       title = "Top 10  <b, style = 'color:#729ec4'>Anime Producer\n",
       subtitle = "Number of anime produced by each producing company",
       caption = "") + #Data: Tidy Tuesday\nwww.fishwongy.com
    coord_flip() +
#  ggsave("producer.png", width = 18, height = 10, dpi = 320) +
NULL

p1
```

#Producer and year
```{r, fig.height=12, fig.width=16}
py1 <- 
pro_yr %>% 
  ggplot(aes(decade, n, fill = producers)) +
  geom_bar(stat = 'identity') +
  scale_y_continuous(expand = expansion(0,0)) + #breaks = seq(from = 0, to =10, by = 2), labels = seq(0, 10, by = 2), expand = expansion(0,0)
  scale_x_continuous(breaks = seq(from = 1950, to =2010, by = 10), labels = paste0(seq(1950, 2010, by = 10), "s")) +
  scale_fill_paletteer_d("dutchmasters::view_of_Delft") +
  #scale_fill_ghibli_d("LaputaLight", direction = -1) +
  #scale_fill_evo("Tangela") +
  labs(title = "Top  <b, style = 'color:#729ec4'>Anime Producers</b> Throughout the Decades\n", 
       subtitle = "Number of anime produced",
       x = "", y = "",
       caption = "Data: Tidy Tuesday\nwww.fishwongy.com") +
  theme_delabj_dark() +
  theme(text = element_text(family = "IBM Plex Sans SemiBold", size = 13),
                      title = element_text("IBM Plex Sans SemiBold", size = 24),
                      plot.title = element_markdown("IBM Plex Sans SemiBold", size = 36),
                      plot.title.position = "plot",
                      plot.subtitle = element_text("IBM Plex Sans SemiBold", size = 25),
                      plot.caption = element_text(size = 20),
                      plot.caption.position = "plot",
                      axis.text = element_text(size = 20, color = "#F5F5F5"),
                      #axis.text.x = element_blank(),
                      axis.line.x = element_line(color = "#F5F5F5"),
                      axis.line.y = element_line(color = "#F5F5F5"),
                      #axis.line.x = element_blank(),
                      #axis.line.y = element_line(color = "gray80"),
                      #panel.grid = element_blank(),
                      legend.text = element_text(size = 18, family = "IBM Plex Sans Medium"),
                      legend.title = element_blank(),
                     # legend.background = element_rect(fill = "#525252", color = "#525252"),
                      plot.margin = margin(20, 20, 20, 20),
                      panel.grid.major.x = element_blank(),
                      panel.grid.minor.x = element_blank(),
                     # panel.grid.major.y = element_line(color = "gray70"),
                      panel.grid.minor.y = element_blank(),
                      #plot.background = element_rect(fill = "#525252", color = "#525252"),
                      legend.position = c(.2, .725)) +
  #ggsave("black-achievements.png", width = 24, height = 12, dpi = 320) +
NULL

py1
```

```{r}
(p1 / py1) +
   ggsave("photo/producer_patch.png", dpi = 320, width = 18, height = 23)
```

#Aggregate mean score 
```{r}
pro_s <- anime %>% 
            select(7, 11) %>%
            drop_na() %>%
            group_by(producers) %>%
            summarise(mean = mean(score)) %>%
            mutate(mean = round(mean, 2)) %>%
            #filter(studio %in% c("TV Tokyo", "Aniplex", "Bandai Visual", "NHK", "Fuji TV", "Sotsu", "Dentsu", "Square Enix",
                         # "AT-X","Kadokawa Shoten", "TBS")) %>%
            left_join(producer, by = "producers") %>%
            arrange(-mean)

pro_s
```

```{r}
p2 <-
pro_s %>%
  filter(producers %in% c("TV Tokyo", "Aniplex", "Bandai Visual", "NHK", "Fuji TV", "Sotsu", "Dentsu", "Square Enix",
                          "AT-X","Kadokawa Shoten", "TBS")) %>%
  
ggplot(aes(x = reorder(producers, mean), y = mean)) + 
  geom_col(fill = "#729ec4") + #position = "dodge", #83B692
  theme_delabj_dark() + 
  scale_y_continuous(position = "right") +
  geom_text(aes(y = mean, label = mean),  nudge_y = -.4, size = 12, color = "white", family="ITC Officina Sans LT Book") +
  theme(text = element_text( family="ITC Officina Sans LT Book", size = 13),
        panel.grid.major = element_line(color = "white", size = 0.3), 
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.background = element_blank(),
        axis.line.x.top = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(family = "ITC Officina Sans LT Bold", size = 25),
        axis.text.y = element_text(size = 25),
        #axis.text.y = element_text(size = 10, family = "ITC Officina Sans LT Bold"),
        plot.title = element_markdown(hjust = 0, vjust=-0.12, size = 36, 
                                  family="ITC Officina Sans LT Bold"),
        plot.subtitle = element_markdown(hjust = 0, vjust=-1.5, size = 25),
       plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0, vjust = -2.5, size = 15)) +
  labs(x = "", y = "", 
       title = "Top 10 <b, style = 'color:#729ec4'>Anime Producer\n",
       subtitle = "Mean anime score rated by viewer",
       caption = "") + #Data: Tidy Tuesday\nwww.fishwongy.com
    coord_flip() +
#  ggsave("black-gender.png", width = 18, height = 10, dpi = 320) +
NULL
p2
```
